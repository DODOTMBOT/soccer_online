// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ПЕРЕЧИСЛЕНИЯ (ENUMS) ---

enum Role {
  USER
  PREMIUM1
  PREMIUM2
  PREMIUM3
  ADMIN
}

enum VflStyle {
  NORMAL
  JOGA_BONITO
  TIKI_TAKA
  GEGENPRESS
  INTENSIVO
  CHOLO
  BUS
}

enum WeatherType {
  SUN
  HEAT
  CLOUDY
  OVERCAST
  RAIN
  SNOW
}

enum Roughness {
  CAREFUL
  NORMAL
  ROUGH
}

enum TeamSpirit {
  SUPER
  NORMAL
  REST
}

enum Mentality {
  SUPER_DEFENSIVE
  DEFENSIVE
  NORMAL
  ATTACKING
  ALL_OUT_ATTACK
}

enum DefenseType {
  MAN_MARKING
  ZONAL
}

enum Formation {
  F442
  F433
  F424
  F532
  F541
  F352
  F343
}

enum Position {
  GK
  LB
  RB
  LD
  RD
  CD
  SW
  LM
  RM
  DM
  CM
  AM
  LF
  RF
  CF
  ST
  FR
}

enum SeasonStatus {
  ACTIVE
  FINISHED
}

enum MatchStatus {
  UPCOMING
  LIVE
  FINISHED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ListingType {
  TRANSFER
  LOAN
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

// --- НОВЫЕ МОДЕЛИ ДЛЯ КАЛЕНДАРЯ ---

model GameDay {
  id          String   @id @default(cuid())
  seasonId    String
  season      Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  
  number      Int      // Порядковый номер дня (1, 2, 3...)
  label       String?  // Виртуальное отображение (напр. "Неделя 1, Суббота")
  
  isCurrent   Boolean  @default(false) // Текущий день в симуляции
  isFinished  Boolean  @default(false) // День завершен (усталость восстановлена)

  timeSlots   GameTimeSlot[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([seasonId, number])
  @@index([isCurrent])
}

model GameTimeSlot {
  id          String   @id @default(cuid())
  gameDayId   String
  gameDay     GameDay  @relation(fields: [gameDayId], references: [id], onDelete: Cascade)
  
  order       Int      // 1 = Утро/День, 2 = Вечер (порядок внутри дня)
  label       String?  // "15:00", "Вечерняя сессия"
  
  matches     Match[]  // Матчи в этот слот

  @@unique([gameDayId, order])
}

// --- ОСНОВНЫЕ МОДЕЛИ ---

model Country {
  id            String   @id @default(cuid())
  name          String   @unique
  flag          String?
  confederation String

  leagues       League[]
  teams         Team[]
  players       Player[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model League {
  id            String   @id @default(cuid())
  name          String
  level         Int      
  teamsCount    Int

  countryId     String
  country       Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)

  seasonId      String
  season        Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  nextLeagueId  String?  @unique
  nextLeague    League?  @relation("LeagueHierarchy", fields: [nextLeagueId], references: [id])
  prevLeague    League?  @relation("LeagueHierarchy")

  teams         Team[]
  matches       Match[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([countryId])
  @@index([seasonId])
}

model Season {
  id            String        @id @default(cuid())
  year          Int           @unique
  status        SeasonStatus  @default(ACTIVE)

  matches       Match[]
  leagues       League[]      
  gameDays      GameDay[]     // Связь с игровыми днями

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model User {
  id            String   @id @default(cuid())
  login         String   @unique
  email         String   @unique
  password      String
  name          String?
  surname       String?
  role          Role     @default(USER)
  balance       BigInt   @default(1000000)

  managedTeam   Team?    @relation("TeamManager")
  applications  TeamApplication[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Team {
  id            String   @id @default(cuid())
  name          String   @unique
  logo          String?
  stadium       String
  
  finances      BigInt   @default(0) 
  baseLevel     Int      @default(1)
  capacity      Int      @default(20000) 

  power         Int      @default(0)
  played        Int      @default(0)
  wins          Int      @default(0)
  draws         Int      @default(0)
  losses        Int      @default(0)
  goalsScored   Int      @default(0)
  goalsConceded Int      @default(0)
  goalsDiff     Int      @default(0)
  points        Int      @default(0)

  countryId     String
  country       Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)

  leagueId      String?
  league        League?  @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  managerId     String?  @unique
  manager       User?    @relation("TeamManager", fields: [managerId], references: [id])

  players       Player[]
  trophies      Trophy[]
  applications  TeamApplication[]

  homeMatches   Match[]  @relation("HomeMatches")
  awayMatches   Match[]  @relation("AwayMatches")
  setups        MatchTeamSetup[]
  
  offersMade    TransferOffer[] @relation("BuyerOffers")
  loanedPlayers Player[]        @relation("LoanOrigin")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([countryId])
  @@index([leagueId])
}

model TeamApplication {
  id         String            @id @default(cuid())
  userId     String
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId     String
  team       Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  status     ApplicationStatus @default(PENDING)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@unique([userId, teamId])
  @@index([status])
}

model Player {
  id              String    @id @default(cuid())
  firstName       String
  lastName        String
  age             Int
  mainPosition    Position
  sidePosition    Position?
  power           Int
  
  potential       Int       @default(70)
  injuryProne     Int       @default(10)
  
  fatigue         Int       @default(0)
  fitness         Int       @default(100)
  formIndex       Int       @default(1)
  currentForm     Int       @default(100)

  favoriteStyle   VflStyle?
  styleKnowledge  Int       @default(0)

  specSpeed       Int @default(0)
  specHeading     Int @default(0)
  specLongPass    Int @default(0)
  specShortPass   Int @default(0)
  specDribbling   Int @default(0)
  specCombination Int @default(0)
  specTackling    Int @default(0)
  specMarking     Int @default(0)
  specShooting    Int @default(0)
  specFreeKicks   Int @default(0)
  specCorners     Int @default(0)
  specPenalty     Int @default(0)
  specCaptain     Int @default(0)
  specLeader      Int @default(0)
  specAthleticism Int @default(0)
  specSimulation  Int @default(0)
  specGkReflexes  Int @default(0)
  specGkOut       Int @default(0)

  price           BigInt?
  isOnTransferList Boolean  @default(false)
  isOnLoanList     Boolean  @default(false)
  transferPrice    BigInt?
  
  loanedFromTeamId String?
  loanedFromTeam   Team?    @relation("LoanOrigin", fields: [loanedFromTeamId], references: [id])
  loanEndsAt       DateTime?

  teamId          String
  team            Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  countryId       String
  country         Country   @relation(fields: [countryId], references: [id], onDelete: Cascade)

  captainOfSetups        MatchTeamSetup[] @relation("SetupCaptain")
  freeKickTakerOfSetups  MatchTeamSetup[] @relation("SetupFreeKick")
  cornerTakerOfSetups    MatchTeamSetup[] @relation("SetupCorner")
  penaltyTakerOfSetups   MatchTeamSetup[] @relation("SetupPenalty")

  lineupSlots    MatchLineupSlot[]
  offers         TransferOffer[]
  history        TransferHistory[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([teamId])
  @@index([countryId])
  @@index([mainPosition])
  @@index([isOnTransferList])
}

model Trophy {
  id          String   @id @default(cuid())
  name        String   
  seasonYear  Int       
  teamId      String
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
}

model Match {
  id             String      @id @default(cuid())
  seasonId       String
  season         Season      @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  leagueId       String
  league         League      @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  
  homeTeamId     String
  homeTeam       Team        @relation("HomeMatches", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeamId     String
  awayTeam       Team        @relation("AwayMatches", fields: [awayTeamId], references: [id], onDelete: Cascade)
  
  tour           Int    
  round          Int         @default(1) 
  homeScore      Int?
  awayScore      Int?
  status         MatchStatus @default(UPCOMING)
  
  // Привязка ко времени (NEW)
  gameTimeSlotId String?
  gameTimeSlot   GameTimeSlot? @relation(fields: [gameTimeSlotId], references: [id])
  
  weather        WeatherType @default(CLOUDY)
  temperature    Int         @default(20)
  attendance     Int         @default(0)
  report         Json?
  setups         MatchTeamSetup[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([seasonId])
  @@index([leagueId])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([tour])
  @@index([gameTimeSlotId]) // Индекс для быстрого поиска матчей слота
}

model MatchTeamSetup {
  id             String       @id @default(cuid())
  matchId        String
  match          Match        @relation(fields: [matchId], references: [id], onDelete: Cascade)
  teamId         String
  team           Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  tactic         VflStyle     @default(NORMAL) 
  formation      Formation    @default(F442)
  mentality      Mentality    @default(NORMAL)
  defenseSetup   DefenseType  @default(ZONAL)
  spirit         TeamSpirit   @default(NORMAL)
  roughness      Roughness    @default(NORMAL)

  captainId        String?
  captain          Player?    @relation("SetupCaptain", fields: [captainId], references: [id])
  freeKickTakerId  String?
  freeKickTaker    Player?    @relation("SetupFreeKick", fields: [freeKickTakerId], references: [id])
  cornerTakerId    String?
  cornerTaker      Player?    @relation("SetupCorner", fields: [cornerTakerId], references: [id])
  penaltyTakerId   String?
  penaltyTaker     Player?    @relation("SetupPenalty", fields: [penaltyTakerId], references: [id])

  matchConditions  Json?
  isSubmitted      Boolean    @default(false)
  submittedAt      DateTime?
  lineupSlots      MatchLineupSlot[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([matchId, teamId])
}

model MatchLineupSlot {
  id                String         @id @default(cuid())
  matchTeamSetupId  String
  matchTeamSetup    MatchTeamSetup @relation(fields: [matchTeamSetupId], references: [id], onDelete: Cascade)
  slotIndex         Int            
  playerId          String
  player            Player         @relation(fields: [playerId], references: [id], onDelete: Restrict)
  assignedPosition  Position       

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([matchTeamSetupId, slotIndex])
  @@index([playerId])
}

model TransferOffer {
  id          String      @id @default(cuid())
  playerId    String
  // ДОБАВЛЕНО onDelete: Cascade
  player      Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  buyerTeamId String
  // ДОБАВЛЕНО onDelete: Cascade
  buyerTeam   Team        @relation("BuyerOffers", fields: [buyerTeamId], references: [id], onDelete: Cascade)
  
  type        ListingType
  price       BigInt      
  swapPlayerId String?    
  loanDuration Int?
  
  status      OfferStatus @default(PENDING)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([playerId, status])
  @@index([buyerTeamId])
}

model TransferHistory {
  id          String      @id @default(cuid())
  playerId    String
  // ДОБАВЛЕНО onDelete: Cascade
  player      Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  fromTeamId  String?
  toTeamId    String?
  price       BigInt
  type        ListingType
  date        DateTime    @default(now())
}